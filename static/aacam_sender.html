<!--
Copyright 2023 Lim Ding Wen

This file is part of Anything Also Cam.

Anything Also Cam is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.

Anything Also Cam is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License along with Anything Also Cam. If not, see <https:www.gnu.org/licenses/>.
-->

<!DOCTYPE html>
<html>
	<head>
		<title>Anything Also Cam (Sender)</title>
		
		<!-- Taken from http://bettermotherfuckingwebsite.com/ -->
		<style>
			body{margin:40px
auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0
10px}h1,h2,h3{line-height:1.2}
		</style>
		
		<style>
			#err {
				color: red;
			}
		</style>
		
		<script>
			let ws;
			
			function disconnect() {
				ws.close();
				document.getElementById("connecting").innerHTML = "";
				document.getElementById("connform").style.display = "";
				document.getElementById("disconnbut").style.display = "none";
			}
			
			function err(e) {
				document.getElementById("connecting").innerHTML = "";
				document.getElementById("err").innerHTML = "Unable to connect. Please double-check the aacam URL you've entered.";
				document.getElementById("connbut").disabled = false;
				document.getElementById("connform").style.display = "";
				document.getElementById("disconnbut").style.display = "none";
			}
			
			function connect() {
				document.getElementById("connecting").innerHTML = "Connecting, please wait...";
				document.getElementById("err").innerHTML = "";
				document.getElementById("connbut").disabled = true;
				
				// Connect via WS
				try {
					ws = new WebSocket("ws://" + document.getElementById("ip").value + ":" + document.getElementById("port").value + "/");
					
					ws.onerror = (async errorEvent => {
						err(errorEvent);
					});
					
					ws.onopen = (async openEvent => {
						// Connect to camera
						let stream = await navigator.mediaDevices.getUserMedia({
							video: true
						});
						let track = stream.getVideoTracks()[0];
						
						// HTML DOM is now in connected mode
						document.getElementById("connecting").innerHTML = "Connected!";
						document.getElementById("connbut").disabled = false;
						document.getElementById("connform").style.display = "none";
						document.getElementById("disconnbut").style.display = "block";
							
						// Receive answers from server
						ws.onmessage = (async messageEvent => {
							// Decode message
							let message = messageEvent.data;
							if (message == "OK_CAM") {
								console.log("S: OK_CAM");
								// Ignore, this just means that everything is ok
							}
							else {
								console.log("[WARN] S: Invalid command: " + message);
							}
						});
						
						// Send handshake to server
						console.log("C: GOT_CAM");
						ws.send("GOT_CAM");
						
						// Start encoding camera
						let trackProcessor = new MediaStreamTrackProcessor(track);
						let reader = trackProcessor.readable.getReader();
						let encoder = new VideoEncoder({
							output: (async chunk => {
								let buffer = new ArrayBuffer(chunk.byteLength);
								chunk.copyTo(buffer);
								let message = new Blob(["GOT_DATA ", buffer]);
								ws.send(message);
							}),
							error: (error => {
								throw error;
							})
						});
						encoder.configure({
							codec: "vp8",
							width: 640,
							height: 480,
							bitrate: 2_000_000,
							framerate: 30
						});
						
						// Send encoded chunks to server
						let frameCounter = 0;
						while (true) {
							// Check if ws has closed
							if (ws.readyState == 2 || ws.readyState == 3) {
								disconnect();
								return;
							}
							
							// Get frame from camera
							let result = await reader.read();
							if (result.done) {
								break;
							}
							let frame = result.value;
							
							// Encode
							if (encoder.encodeQueueSize > 2) {
								// Drop frame
								// TODO: Use proper logging
								console.log("[WARN] Dropping frame");
								frame.close();
							}
							else {
								frameCounter++;
								encoder.encode(result.value, {
									keyFrame: frameCounter % 150 == 0
								});
								frame.close();
							}
						}
						console.log("[ERROR] Camera feed ended.");
					});
				}
				catch (e) {
					err(e);
				}
			}
		</script>
	</head>
	
	<body>
		<h1>
			Anything Also Cam (Sender)
		</h1>
		
		<p>Please allow camera permissions. For privacy reasons, your camera data will only stay on your local network. Because of this, make sure the two devices are on the same network.</p>
		
		<p id="err"></p>
		<p id="connecting"></p>
		
		<form onsubmit="connect();" action="#" id="connform">
			<p>aacam://<input id="ip">:<input value="4546" id="port"></p>
			<p><input type="submit" value="Connect" id="connbut"></p>
		</form>
		
		<p><input type="button" value="Disconnect" id="disconnbut" onclick="disconnect();" style="display:none;"></p>
	</body>
</html>
